---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: loki
  namespace: monitoring
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://grafana.github.io/helm-charts
      chart: loki
      version: 3.0.3
      sourceRef:
        kind: HelmRepository
        name: grafana-charts
        namespace: flux-system
      interval: 5m
  values:
    ingress:
      enabled: true
      annotations:
        kubernetes.io/ingress.class: "nginx"
      hosts:
        - "loki.${SECRET_DOMAIN}"
      # tls:
      #   - hosts:
      #       - "loki.${SECRET_DOMAIN}"

    loki:
      commonConfig:
        replication_factor: 1
      storage:
        type: 'filesystem'

    #   config:
    #     auth_enabled: false
    #     server:
    #       http_listen_port: 3100
    #     limits_config:
    #       enforce_metric_name: false
    #       reject_old_samples: true
    #       reject_old_samples_max_age: 168h
    #     # chunk_store_config:
    #     #   max_look_back_period: 0s
    #     ruler:
    #       storage:
    #         type: local
    #         local:
    #           directory: /rules
    #       rule_path: /tmp/scratch
    #       alertmanager_url: http://kube-prometheus-stack-alertmanager:9093
    #       ring:
    #         kvstore:
    #           store: inmemory
    #       enable_api: true
    #     ingester:
    #       chunk_idle_period: 3m
    #       chunk_block_size: 262144
    #       chunk_retain_period: 1m
    #       max_transfer_retries: 0
    #       wal:
    #         dir: /data/loki/wal
    #       lifecycler:
    #         ring:
    #           kvstore:
    #             store: inmemory


    #     storage_config:
    #       boltdb_shipper:
    #         active_index_directory: /data/loki/boltdb-shipper-active
    #         cache_location: /data/loki/boltdb-shipper-cache
    #         cache_ttl: 24h # Can be increased for faster performance over longer query periods, uses more disk space
    #         shared_store: filesystem
    #       filesystem:
    #         directory: /data/loki/chunks

    #     table_manager:
    #       retention_deletes_enabled: false
    #       retention_period: 0s
    #     compactor:
    #       working_directory: /data/loki/boltdb-shipper-compactor
    #       shared_store: filesystem
    #     # https://grafana.com/docs/loki/latest/rules/

    # # alerting_groups:
    # #   #
    # #   # SMART Failures
    # #   #
    # #   - name: smart-failure
    # #     rules:
    # #       - alert: SmartFailures
    # #         expr: |
    # #           sum by (host) (count_over_time({host=~".+"} | json | _SYSTEMD_UNIT = "smartmontools.service" !~ "(?i)previous self-test completed without error" !~ "(?i)Prefailure" |~ "(?i)(error|fail)"[2m])) > 0
    # #         for: 10s
    # #         labels:
    # #           severity: critical
    # #           category: logs
    # #         annotations:
    # #           summary: "SMART has reported failures on host {{ $labels.hostname }}"

    # attempt to fix this:
    # https://github.com/grafana/loki/issues/7047
    monitoring:
      dashboards:
        # -- If enabled, create configmap with dashboards for monitoring Loki
        enabled: true
      rules:
        # -- If enabled, create PrometheusRule resource with Loki recording rules
        enabled: true
      alerts:
        # -- If enabled, create PrometheusRule resource with Loki alerting rules
        enabled: true
      serviceMonitor:
        # -- If enabled, ServiceMonitor resources for Prometheus Operator are created
        enabled: true
      selfMonitoring:
        enabled: false
        grafanaAgent:
          installOperator: false

    persistence:
      enabled: true
      accessModes:
        - ReadWriteOnce
      size: 30Gi
      existingClaim: nfs-nebula-loki-pvc
    securityContext:
      fsGroup: 2316
      runAsGroup: 2316
      runAsNonRoot: true
      runAsUser: 2316
