---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: loki
  namespace: monitoring
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://grafana.github.io/helm-charts
      chart: loki
      version: 2.8.1
      sourceRef:
        kind: HelmRepository
        name: grafana-charts
        namespace: flux-system
      interval: 5m
  values:
    ingress:
      enabled: false
      annotations:
        kubernetes.io/ingress.class: "nginx"
      hosts:
        - host: "loki.${SECRET_DOMAIN}"
          paths:
            - /
      tls:
        - hosts:
            - "loki.${SECRET_DOMAIN}"
    serviceMonitor:
      enabled: true

    config:
      # existingSecret:
      auth_enabled: false
      ingester:
        chunk_idle_period: 3m
        chunk_block_size: 262144
        chunk_retain_period: 1m
        max_transfer_retries: 0
        wal:
          dir: /data/loki/wal
        lifecycler:
          ring:
            kvstore:
              store: inmemory
      limits_config:
        enforce_metric_name: false
        reject_old_samples: true
        reject_old_samples_max_age: 168h
      schema_config:
        configs:
        - from: '2020-10-24'
          store: boltdb-shipper
          object_store: filesystem
          schema: v11
          index:
            prefix: index_
            period: 24h
      server:
        http_listen_port: 3100
      storage_config:
        boltdb_shipper:
          active_index_directory: /data/loki/boltdb-shipper-active
          cache_location: /data/loki/boltdb-shipper-cache
          cache_ttl: 24h         # Can be increased for faster performance over longer query periods, uses more disk space
          shared_store: filesystem
        filesystem:
          directory: /data/loki/chunks
      chunk_store_config:
        max_look_back_period: 0s
      table_manager:
        retention_deletes_enabled: false
        retention_period: 0s
      compactor:
        working_directory: /data/loki/boltdb-shipper-compactor
        shared_store: filesystem
      ruler:
        storage:
          type: local
          local:
            directory: /rules
        rule_path: /tmp/scratch
        alertmanager_url: http://kube-prometheus-stack-alertmanager:9093
        ring:
          kvstore:
            store: inmemory
        enable_api: true

    persistence:
      enabled: true
      existingClaim: nfs-loki-pvc
    securityContext:
      fsGroup: 2316
      runAsGroup: 2316
      runAsNonRoot: true
      runAsUser: 2316
  # TODO: https://github.com/grafana/helm-charts/pull/700
  postRenderers:
    - kustomize:
        patchesJson6902:
          - target:
              version: v1beta1
              kind: Ingress
              name: loki
            patch:
              - op: replace
                path: /apiVersion
                value: networking.k8s.io/v1
              - op: remove
                path: /spec/rules/0/http/paths/0/backend/servicePort
              - op: remove
                path: /spec/rules/0/http/paths/0/backend/serviceName
              - op: add
                path: /spec/rules/0/http/paths/0/backend/service
                value:
                  name: loki
                  port:
                    name: http-metrics
              - op: add
                path: /spec/rules/0/http/paths/0/pathType
                value: Prefix
